# íŒŒì¼ ì´ë¦„: main.py (ì „ëµ ì ìš© í›„ ìˆ˜ì •ëœ ë²„ì „)

import streamlit as st
import pandas as pd

# ê° íƒ­ì˜ render í•¨ìˆ˜ë¥¼ import í•©ë‹ˆë‹¤.
import tab_search
import tab_basic_dashboard
import tab_country_deepdive  # ë‚˜ì¤‘ì— ìˆ˜ì •í•  ê²ƒì´ë¯€ë¡œ ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬
import tab_deep_dashboard

# ==============================================================================
# âœ¨ 1. ìƒíƒœ(State) ì´ˆê¸°í™”: í•˜ë‚˜ì˜ ë°ì´í„° ì €ì¥ì†Œì™€ í•˜ë‚˜ì˜ ì•¡ì…˜ ë³´ê´€í•¨ìœ¼ë¡œ í†µí•©
# ==============================================================================
st.set_page_config(layout="wide")

def initialize_state():
    """ì•± ì„¸ì…˜ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜"""
    # ë°ì´í„°ëŠ” ì¢…ë¥˜ì— ìƒê´€ì—†ì´ í•˜ë‚˜ì˜ ë³€ìˆ˜ì— ì €ì¥
    if 'data' not in st.session_state:
        st.session_state.data = pd.DataFrame()
    # í˜„ì¬ ë°ì´í„°ì˜ ì¢…ë¥˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” 'íƒ€ì…' ë³€ìˆ˜
    if 'data_type' not in st.session_state:
        st.session_state.data_type = None  # 'search' ë˜ëŠ” 'analysis'ê°€ ë  ì˜ˆì •
    # íƒ­ì—ì„œ ì˜¬ë¦° ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ 'ì•¡ì…˜'
    if 'pending_action' not in st.session_state:
        st.session_state.pending_action = None

# ì•±ì´ ì‹œì‘(ë˜ëŠ” ì¬ë¡œë”©)ë  ë•Œë§ˆë‹¤ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
initialize_state()


# ==============================================================================
# âœ¨ 2. ì¤‘ì•™ ì•¡ì…˜ ì²˜ë¦¬ ë¡œì§: ëª¨ë“  ìƒíƒœ ë³€ê²½ì€ ì—¬ê¸°ì„œë§Œ!
# ==============================================================================
# ì²˜ë¦¬í•  ì•¡ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
if st.session_state.pending_action is not None:

    # ì•¡ì…˜ì˜ ë‚´ìš©(ì¢…ë¥˜, ë°ì´í„°)ì„ êº¼ëƒ„
    action_type, payload = st.session_state.pending_action

    if action_type == 'SEARCH_ACTION':
        # ê²€ìƒ‰ ì•¡ì…˜ ì²˜ë¦¬
        st.session_state.data = payload
        st.session_state.data_type = 'search'
        st.toast("ê²€ìƒ‰ ì™„ë£Œ! ê²€ìƒ‰ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")

    elif action_type == 'UPLOAD_ACTION':
        # ì—…ë¡œë“œ ì•¡ì…˜ ì²˜ë¦¬
        st.session_state.data = payload
        st.session_state.data_type = 'analysis'
        st.toast("íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! ë¶„ì„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # ì•¡ì…˜ ì²˜ë¦¬ê°€ ëë‚¬ìœ¼ë¯€ë¡œ, ë³´ê´€í•¨ì„ ë¹„ì›Œì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    st.session_state.pending_action = None


# ==============================================================================
# 3. ë©”ì¸ ì•± UI ë Œë”ë§
# ==============================================================================

def render_home_tab():
    """í™ˆ íƒ­ì˜ ë‚´ìš©ì„ ë Œë”ë§í•©ë‹ˆë‹¤. (ì´ í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ)"""
    st.header("ğŸ  ì‹œìŠ¤í…œ ì•ˆë‚´")
    st.info("ì´ ì‹œìŠ¤í…œì€ ë…¼ë¬¸ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ë¶„ì„í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.")
    st.markdown("---")
    st.warning("""
    #### â€» ì¤‘ìš”: ë¶„ì„ ê¸°ëŠ¥ ì‚¬ìš©ë²•
    ì´ ì‹œìŠ¤í…œì€ ë‘ ê°€ì§€ ëª¨ë“œë¡œ ì‘ë™í•©ë‹ˆë‹¤.
    - **ê²€ìƒ‰ ëª¨ë“œ**: 'ë…¼ë¬¸ ê²€ìƒ‰' íƒ­ì—ì„œ ê²€ìƒ‰ì„ ì‹¤í–‰í•œ ìƒíƒœì…ë‹ˆë‹¤.
    - **ë¶„ì„ ëª¨ë“œ**: 'ê¸°ë³¸ ë™í–¥ ë¶„ì„' íƒ­ ë“±ì—ì„œ íŒŒì¼ì„ ì§ì ‘ ì—…ë¡œë“œí•œ ìƒíƒœì…ë‹ˆë‹¤.
    
    í•˜ë‚˜ì˜ ëª¨ë“œê°€ í™œì„±í™”ë˜ë©´ ë‹¤ë¥¸ ëª¨ë“œì˜ ë°ì´í„°ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.
    """)
    st.markdown("---")
    st.markdown("#### ê° íƒ­ì˜ ì—­í• ")
    st.markdown("""
    - **`ğŸ  í™ˆ`**: 
      - í˜„ì¬ ë³´ê³  ê³„ì‹  í™”ë©´ìœ¼ë¡œ, ì‹œìŠ¤í…œ ì‚¬ìš©ë²•ê³¼ ê° íƒ­ì˜ ê¸°ëŠ¥ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

    - **`ğŸ” ë…¼ë¬¸ ê²€ìƒ‰ ë° ìˆ˜ì§‘`**: 
      - OpenAlex APIë¥¼ ì‚¬ìš©í•˜ì—¬ í‚¤ì›Œë“œë¡œ ë…¼ë¬¸ì„ ê²€ìƒ‰í•˜ê³ , ê²°ê³¼ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì§‘í•©ë‹ˆë‹¤. ê²€ìƒ‰ì´ ì™„ë£Œë˜ë©´ 'ê²€ìƒ‰ ëª¨ë“œ'ê°€ í™œì„±í™”ë˜ì–´ ë‹¤ë¥¸ íƒ­ì—ì„œ ë¶„ì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - **`ğŸ“Š ê¸°ë³¸ ë™í–¥ ë¶„ì„`**: 
      - ì—…ë¡œë“œí•˜ê±°ë‚˜ ê²€ìƒ‰í•œ ë°ì´í„°ì˜ ê¸°ë³¸ì ì¸ í†µê³„ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤. ì—°ë„ë³„ ë…¼ë¬¸ ë°œí–‰ ìˆ˜, ìƒìœ„ ì €ë„/ì €ì ë“±ì˜ ì •ë³´ë¥¼ ì‹œê°í™”í•˜ì—¬ ì „ì²´ì ì¸ ë™í–¥ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - **`ğŸ”¬ êµ­ê°€ë³„ ì‹¬ì¸µ ë¶„ì„`**: 
      - ê° êµ­ê°€ë³„ ë…¼ë¬¸ ë°œí–‰ í˜„í™©ê³¼ ì¸ìš© ìˆ˜ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤. íŠ¹ì • êµ­ê°€ì˜ ì—°êµ¬ ë™í–¥ì´ë‚˜ ì£¼ìš” ì—°êµ¬ ê¸°ê´€ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

    - **`âœ¨ í‚¤ì›Œë“œ ë™í–¥ ë¶„ì„`**: 
      - ë…¼ë¬¸ ì´ˆë¡(Abstract)ì—ì„œ í•µì‹¬ í‚¤ì›Œë“œë¥¼ ì¶”ì¶œí•˜ê³ , ì›Œë“œí´ë¼ìš°ë“œë‚˜ ì—°ê´€ ë¶„ì„ì„ í†µí•´ ì—°êµ¬ ì£¼ì œì˜ íŠ¸ë Œë“œ ë³€í™”ë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
    """)

st.title("ğŸ“š ë…¼ë¬¸ ë¶„ì„ ì‹œìŠ¤í…œ")

tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "ğŸ  í™ˆ",
    "ğŸ” ë…¼ë¬¸ ê²€ìƒ‰ ë° ìˆ˜ì§‘",
    "ğŸ“Š ê¸°ë³¸ ë™í–¥ ë¶„ì„",
    "ğŸ”¬ êµ­ê°€ë³„ ì‹¬ì¸µ ë¶„ì„",
    "âœ¨ í‚¤ì›Œë“œ ë™í–¥ ë¶„ì„"
])

with tab1:
    render_home_tab()

with tab2:
    # âœ¨ ê²€ìƒ‰ íƒ­ì—ëŠ” ì•„ë¬´ ì¸ìë„ ì „ë‹¬í•  í•„ìš”ê°€ ì—†ìŒ.
    #    (ì•¡ì…˜ ë“±ë¡ì€ íƒ­ ë‚´ë¶€ì—ì„œ st.session_stateë¥¼ í†µí•´ ì§ì ‘ í•˜ê¸° ë•Œë¬¸)
    tab_search.render()

with tab3:
    # âœ¨ ë¶„ì„ íƒ­ì—ëŠ” í˜„ì¬ 'ë°ì´í„°'ì™€ 'ë°ì´í„° íƒ€ì…'ì„ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬
    #    í™”ë©´ì„ ì–´ë–»ê²Œ ê·¸ë¦´ì§€ ê²°ì •í•˜ê²Œ í•¨.
    tab_basic_dashboard.render(st.session_state.data, st.session_state.data_type)

with tab4:
    tab_country_deepdive.render(st.session_state.data, st.session_state.data_type)

with tab5:
    tab_deep_dashboard.render(st.session_state.data, st.session_state.data_type)