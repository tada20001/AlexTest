# íŒŒì¼ ì´ë¦„: main.py (ì „ëµ ì ìš© í›„ ìˆ˜ì •ëœ ë²„ì „)

import streamlit as st
import pandas as pd

# ê° íƒ­ì˜ render í•¨ìˆ˜ë¥¼ import í•©ë‹ˆë‹¤.
import tab_search
import tab_basic_dashboard
import tab_country_deepdive  # ë‚˜ì¤‘ì— ìˆ˜ì •í•  ê²ƒì´ë¯€ë¡œ ì¼ë‹¨ ì£¼ì„ ì²˜ë¦¬
import tab_deep_dashboard

# ==============================================================================
# âœ¨ 1. ìƒíƒœ(State) ì´ˆê¸°í™”: í•˜ë‚˜ì˜ ë°ì´í„° ì €ì¥ì†Œì™€ í•˜ë‚˜ì˜ ì•¡ì…˜ ë³´ê´€í•¨ìœ¼ë¡œ í†µí•©
# ==============================================================================
st.set_page_config(layout="wide")

def initialize_state():
    """ì•± ì„¸ì…˜ ìƒíƒœë¥¼ ì´ˆê¸°í™”í•˜ëŠ” í•¨ìˆ˜"""
    # ë°ì´í„°ëŠ” ì¢…ë¥˜ì— ìƒê´€ì—†ì´ í•˜ë‚˜ì˜ ë³€ìˆ˜ì— ì €ì¥
    if 'data' not in st.session_state:
        st.session_state.data = pd.DataFrame()
    # í˜„ì¬ ë°ì´í„°ì˜ ì¢…ë¥˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” 'íƒ€ì…' ë³€ìˆ˜
    if 'data_type' not in st.session_state:
        st.session_state.data_type = None  # 'search' ë˜ëŠ” 'analysis'ê°€ ë  ì˜ˆì •
    # íƒ­ì—ì„œ ì˜¬ë¦° ì²˜ë¦¬ ëŒ€ê¸° ì¤‘ì¸ 'ì•¡ì…˜'
    if 'pending_action' not in st.session_state:
        st.session_state.pending_action = None

# ì•±ì´ ì‹œì‘(ë˜ëŠ” ì¬ë¡œë”©)ë  ë•Œë§ˆë‹¤ ìƒíƒœ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
initialize_state()


# ==============================================================================
# âœ¨ 2. ì¤‘ì•™ ì•¡ì…˜ ì²˜ë¦¬ ë¡œì§: ëª¨ë“  ìƒíƒœ ë³€ê²½ì€ ì—¬ê¸°ì„œë§Œ!
# ==============================================================================
# ì²˜ë¦¬í•  ì•¡ì…˜ì´ ìˆëŠ”ì§€ í™•ì¸
if st.session_state.pending_action is not None:

    # ì•¡ì…˜ì˜ ë‚´ìš©(ì¢…ë¥˜, ë°ì´í„°)ì„ êº¼ëƒ„
    action_type, payload = st.session_state.pending_action

    if action_type == 'SEARCH_ACTION':
        # ê²€ìƒ‰ ì•¡ì…˜ ì²˜ë¦¬
        st.session_state.data = payload
        st.session_state.data_type = 'search'
        st.toast("ë°ì´í„° ìˆ˜ì§‘ ì™„ë£Œ! ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.")

    elif action_type == 'UPLOAD_ACTION':
        # ì—…ë¡œë“œ ì•¡ì…˜ ì²˜ë¦¬
        st.session_state.data = payload
        st.session_state.data_type = 'analysis'
        st.toast("íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ! ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤.")

    # ì•¡ì…˜ ì²˜ë¦¬ê°€ ëë‚¬ìœ¼ë¯€ë¡œ, ë³´ê´€í•¨ì„ ë¹„ì›Œì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    st.session_state.pending_action = None


# ==============================================================================
# 3. ë©”ì¸ ì•± UI ë Œë”ë§
# ==============================================================================

def render_home_tab():
    """í™ˆ íƒ­ì˜ ë‚´ìš©ì„ ë Œë”ë§í•©ë‹ˆë‹¤. (ì´ í•¨ìˆ˜ëŠ” ë³€ê²½ ì—†ìŒ)"""
    st.header("ğŸ  ì‹œìŠ¤í…œ ì•ˆë‚´")
    st.info("ì´ ì‹œìŠ¤í…œì€ **ë‘ ë‹¨ê³„**ë¡œ ì‘ë™í•©ë‹ˆë‹¤. **(1ë‹¨ê³„) ë°ì´í„°ë¥¼ ìˆ˜ì§‘**í•˜ê³ , **(2ë‹¨ê³„) ìˆ˜ì§‘ëœ ë°ì´í„°ë¥¼ ë¶„ì„**í•©ë‹ˆë‹¤.")
    st.markdown("---")
    st.subheader("âœ… 1ë‹¨ê³„: ë°ì´í„° ìˆ˜ì§‘í•˜ê¸°")
    st.markdown(
        "##### **ğŸ” ë…¼ë¬¸ ê²€ìƒ‰ ë° ìˆ˜ì§‘** íƒ­ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”."
    )
    st.write(
        "ì—¬ê¸°ì„œëŠ” ì›í•˜ëŠ” í‚¤ì›Œë“œë¡œ ë…¼ë¬¸ì„ ê²€ìƒ‰í•˜ê³  ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. "
        "ê²€ìƒ‰ì´ ì™„ë£Œë˜ë©´, ê²°ê³¼ë¥¼ ë°”ë¡œ í™•ì¸í•˜ê³  **[ì—‘ì…€ íŒŒì¼ë¡œ ë‹¤ìš´ë¡œë“œ]** ë²„íŠ¼ì„ ëˆŒëŸ¬ ë¶„ì„ìš© ë°ì´í„°ë¥¼ PCì— ì €ì¥í•˜ì„¸ìš”."
    )
    st.markdown("---")

    st.subheader("âœ… 2ë‹¨ê³„: ë°ì´í„° ë¶„ì„í•˜ê¸°")
    st.markdown(
        "##### ğŸ“Š **ê¸°ë³¸ ë™í–¥**, ğŸ”¬ **êµ­ê°€ë³„ ë¶„ì„**, âœ¨ **í‚¤ì›Œë“œ ë¶„ì„** íƒ­ìœ¼ë¡œ ì´ë™í•˜ì„¸ìš”."
    )
    st.write("""
        ê° ë¶„ì„ íƒ­ ìƒë‹¨ì— ìˆëŠ” **[íŒŒì¼ ì—…ë¡œë“œ]** ì˜ì—­ì—, **1ë‹¨ê³„ì—ì„œ ë‹¤ìš´ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼**ì„ ëŒì–´ë‹¤ ë†“ìœ¼ë©´ 
        ì¦‰ì‹œ ì‹¬ì¸µ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤. """
    )

    st.markdown("---")

    st.markdown(
        """
        <div style="background-color: #FFF3CD; border-left: 5px solid #FFC107; padding: 10px; border-radius: 5px;">
            âš ï¸ <strong>â€» ì¤‘ìš” ì•ˆë‚´</strong><br>
            - ëª¨ë“  ë¶„ì„ íƒ­ë“¤ì€ ë°˜ë“œì‹œ <strong>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì•¼</strong> ë‚´ìš©ì´ í‘œì‹œë©ë‹ˆë‹¤.<br>
            - íŒŒì¼ í•˜ë‚˜ë¥¼ ì—…ë¡œë“œí•˜ë©´ <strong>3ê°œì˜ ë¶„ì„ íƒ­ ëª¨ë‘ì—ì„œ ê³µìœ </strong>í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        </div>
        """,
        unsafe_allow_html=True
    )

st.title("ğŸ“š ë…¼ë¬¸ ë¶„ì„ ì‹œìŠ¤í…œ")

tab1, tab2, tab3, tab4, tab5 = st.tabs([
    "ğŸ  í™ˆ (ì‚¬ìš©ë²•)",
    "ğŸ” 1. ë…¼ë¬¸ ê²€ìƒ‰",
    "ğŸ“Š 2. ê¸°ë³¸ ë™í–¥ ë¶„ì„",
    "ğŸ”¬ 3. êµ­ê°€ë³„ ì‹¬ì¸µ ë¶„ì„",
    "âœ¨ 4. í‚¤ì›Œë“œ ë™í–¥ ë¶„ì„"
])

with tab1:
    render_home_tab()

with tab2:
    # âœ¨ ê²€ìƒ‰ íƒ­ì—ëŠ” ì•„ë¬´ ì¸ìë„ ì „ë‹¬í•  í•„ìš”ê°€ ì—†ìŒ.
    #    (ì•¡ì…˜ ë“±ë¡ì€ íƒ­ ë‚´ë¶€ì—ì„œ st.session_stateë¥¼ í†µí•´ ì§ì ‘ í•˜ê¸° ë•Œë¬¸)
    tab_search.render()

with tab3:
    # âœ¨ ë¶„ì„ íƒ­ì—ëŠ” í˜„ì¬ 'ë°ì´í„°'ì™€ 'ë°ì´í„° íƒ€ì…'ì„ ì¸ìë¡œ ì „ë‹¬í•˜ì—¬
    #    í™”ë©´ì„ ì–´ë–»ê²Œ ê·¸ë¦´ì§€ ê²°ì •í•˜ê²Œ í•¨.
    tab_basic_dashboard.render(st.session_state.data, st.session_state.data_type)

with tab4:
    tab_country_deepdive.render(st.session_state.data, st.session_state.data_type)

with tab5:
    tab_deep_dashboard.render(st.session_state.data, st.session_state.data_type)